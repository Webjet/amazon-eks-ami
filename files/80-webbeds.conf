#--------- Ranges
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 1024 65535
fs.file-max = 300000
#--------- Timeouts
net.ipv4.tcp_fin_timeout = 5
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 5
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 10
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 10
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 40
# net.netfilter.nf_conntrack_tcp_timeout_established = 432000 
net.netfilter.nf_conntrack_tcp_timeout_established = 1200
net.ipv4.tcp_synack_retries = 3
#--------- MAX
# net.netfilter.nf_conntrack_max = 1048576
# net.netfilter.nf_conntrack_max = 2097152
net.netfilter.nf_conntrack_max = 8388608
# 10*1024^3/16384/2
# net.netfilter.nf_conntrack_max = 327680

# net.netfilter.nf_conntrack_expect_max = 1024
# net.netfilter.nf_conntrack_expect_max = 8192
# net.netfilter.nf_conntrack_expect_max = 2097152
net.netfilter.nf_conntrack_expect_max = 8388608

#--------- Mem
# The tcp_mem variable defines how the TCP stack should behave when it comes to memory usage. ... The first value specified in the tcp_mem variable tells the kernel the low threshold. Below this point, the TCP stack do not bother at all about putting any pressure on the memory usage by different TCP sockets. ... The second value tells the kernel at which point to start pressuring memory usage down. ... The final value tells the kernel how many memory pages it may use maximally. If this value is reached, TCP streams and packets start getting dropped until we reach a lower memory usage again. This value includes all TCP sockets currently in use.
# net.ipv4.tcp_mem = 10629 14173 21258
# net.ipv4.tcp_mem = 50576 64768 98152
# net.ipv4.tcp_mem 8388608 8388608 8388608

net.ipv4.tcp_mem = 16777216 16777216 16777216

# net.core.rmem_max = 16777216
# net.core.rmem_default = 87380
# net.ipv4.tcp_rmem = 4096 87380 16777216
# 
# net.core.wmem_max = 16777216
# net.core.wmem_default = 87380
# net.ipv4.tcp_wmem = 4096 87380 16777216

# allow testing with buffers up to 128MB
net.core.rmem_max = 134217728
net.core.rmem_default = 87380
net.core.wmem_max = 134217728
net.core.wmem_default = 65536
# increase Linux autotuning TCP buffer limit to 64MB
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# recommended for hosts with jumbo frames enabled
net.ipv4.tcp_mtu_probing=1

#------------------------ tunning --------------------------#

#--------- GC
# net.ipv4.neigh.default.gc_thresh1 = 128
net.ipv4.neigh.default.gc_thresh1 = 4096
# net.ipv4.neigh.default.gc_thresh2 = 512
net.ipv4.neigh.default.gc_thresh2 = 8192
# net.ipv4.neigh.default.gc_thresh3 = 1024
net.ipv4.neigh.default.gc_thresh3 = 8192
# net.ipv4.neigh.default.gc_stale_time = 60
net.ipv4.neigh.default.gc_stale_time = 300

#----------

net.ipv4.tcp_max_orphans = 262144

# net.core.somaxconn = 128
# net.core.somaxconn = 10240
# net.core.somaxconn = 32768
net.core.somaxconn = 3240000

# net.core.dev_weight = 64
net.core.dev_weight = 1024

# #---------
# # net.core.rmem_max = 212992
# net.core.rmem_max = 262144
# # net.core.rmem_max = 335544320
# 
# # net.core.rmem_default = 212992
# net.core.rmem_default = 262144
# # net.core.rmem_default = 335544320
# 
# # net.core.wmem_max = 212992
# net.core.wmem_max = 262144
# # net.core.wmem_max = 83886080
# 
# # net.core.wmem_default = 212992
# net.core.wmem_default = 262144
# # net.core.wmem_default = 83886080

# net.ipv4.tcp_max_tw_buckets = 4096
net.ipv4.tcp_max_tw_buckets = 65536

# net.ipv4.tcp_max_syn_backlog = 128
# net.ipv4.tcp_max_syn_backlog = 8192
# net.ipv4.tcp_max_syn_backlog = 65536
net.ipv4.tcp_max_syn_backlog = 3240000

# net.core.netdev_max_backlog = 1000
net.core.netdev_max_backlog = 16384
# net.core.netdev_max_backlog = 250000

net.ipv4.tcp_syncookies = 1
# net.ipv4.tcp_syncookies = 0

# net.ipv4.tcp_timestamps are 1, the server will check the Timestamps in each message. If Timestamps in the message are not incremental, the server will not intercept the message. But the NAT configured clients have the same source IP, each client's time before configuring NAT may be different, so the server may intercept the message because the Timestamps in the message are not incremental
# net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_timestamps = 0

#net.ipv4.tcp_congestion_control = bbr
#net.core.default_qdisc = fq

net.netfilter.nf_conntrack_buckets = 327680
